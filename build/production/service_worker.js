import{d as b,o as k,l as f,a as d}from"./assets/chunk-constants.js";import{l as g}from"./assets/chunk-lodash.js";async function w(){let e=await A();await chrome.storage.local.set({...g.pick(e.websites.amazon,"detail_page_asin","page_not_found","detail_page_subcontainer","list_page_container","list_page_grid_container","list_page_subcontainer","detail_page_middle_container"),...g.pick(e.urls,"arbitrage_authenticate_api","arbitrage_reverse_search","arbitrage_authenticate_api_fallback","arbitrage_reverse_search_fallback","arbitrage_website"),...g.pick(e.profitCalculator,"vat_flat_rate"),auth_key:decodeURIComponent(atob(e.auth_key)),fulfilment_fee_distribution:e.profitCalculator,fulfilment_fee_distribution_xpaths:e.productDetailsPageXpath,profit_calculator_drop_down:!0,pricing_and_offerings_drop_down:!1,reverse_search_drop_down:!1,google_shopping_drop_down:!1})}const v=()=>{let e={};for(let o=0;o<b.length;o++)e[b[o]]=o;chrome.storage.local.set({compartmentPositions:e})};async function m(){try{const{auth_key:e}=await chrome.storage.local.get(["auth_key"]);return await h({action:"get_supported_stores",authKey:e})}catch(e){console.log("Error in fetching get_supported_stores",e)}}async function A(){const e={headers:{"Content-Type":"application/json"},method:"GET"},o="https://api.ahonline.top/private/extension/extension_config.json",t="https://app.arbitragehero.com/private/extension/extension_config.json";return await p(o,e)||await p(t,e)}async function h(e,o=null,t=!1){let{arbitrage_authenticate_api:a,arbitrage_authenticate_api_fallback:r}=await chrome.storage.local.get(["arbitrage_authenticate_api","arbitrage_authenticate_api_fallback"]);a||(await w(),{arbitrage_authenticate_api:a,arbitrage_authenticate_api_fallback:r}=await chrome.storage.local.get(["arbitrage_authenticate_api","arbitrage_authenticate_api_fallback"]));const i=new FormData;if(Object.entries(e).forEach(([c,u])=>i.append(c,u)),o)for(const c of o)i.append("asins[]",c);const n={method:"POST",body:i,redirect:"follow"};let s;return t&&(s=await p(r,n)),s||(s=await p(a,n)||await p(r,n)),s}async function p(e,o){try{const t=new AbortController;o.signal=t.signal;const a=setTimeout(()=>t.abort(),1e4);let r=await fetch(e,o);return clearTimeout(a),await r.json()}catch(t){console.log("Api Url Invalid Response: ",t)}}async function K(e){try{const{auth_key:o}=await chrome.storage.local.get(["auth_key"]);let a=await h({action:"api_key_check",authKey:o,apiKey:e});if(a.license){const{apiKeyResponse:r}=await chrome.storage.local.get(["apiKeyResponse"]);if(await chrome.storage.local.set({apiKeyResponse:a,apiKey:e,keyExpired:!1}),r){const{compartmentPositions:i}=await chrome.storage.local.get(["compartmentPositions"]);(Object.keys(r.access)[0]!=Object.keys(a.access)[0]||!i)&&v()}else v()}else{const{apiKey:r}=await chrome.storage.local.get(["apiKey"]);r&&await chrome.storage.local.set({keyExpired:!0,key_validated:!1}),await chrome.storage.local.set({apiKeyResponse:null,apiKey:null})}return a}catch(o){console.log("Error in api_key_check call",o)}}async function S(e,o,t){try{if(e){let{auth_key:a}=await chrome.storage.local.get(["auth_key"])||decodeURIComponent(atob("ZmQxNjA2MjAtYmQzYy0xY2M0LTMxOWUtYzU1Nzg2YjFiYjlj"));const{apiKey:r}=await chrome.storage.local.get(["apiKey"]);let n=await h({action:"reverse_search",authKey:a,market:o,apiKey:r},e,t);return n=await P(n,r),n}}catch(a){console.log("Error in fetching Reverse Search Data",a)}}async function T(e,o,t,a,r,i,n){try{if(e){let{auth_key:s}=await chrome.storage.local.get(["auth_key"])||decodeURIComponent(atob("ZmQxNjA2MjAtYmQzYy0xY2M0LTMxOWUtYzU1Nzg2YjFiYjlj"));const{apiKey:c}=await chrome.storage.local.get(["apiKey"]);let u={action:"reverse_search",authKey:s,market:o,apiKey:c,marketplace:t};r&&/\d/.test(r)&&(u.BSR=r),i&&(u.category=i,u.salePrice=n);let l=await h(u,e,a);return l=await P(l,c),l}}catch(s){console.log("Error in fetching Reverse Search Data",s)}}async function P(e,o){try{e.license_status.license?await chrome.storage.local.set({apiKeyResponse:e.license_status,apiKey:o,keyExpired:!1}):await chrome.storage.local.set({apiKeyResponse:null,apiKey:null,keyExpired:!0})}catch{return"response_null"}return e}async function W(e){const o={method:"GET",redirect:"follow"};try{const t=await fetch(e,o);return t.status===200?await t.text():void 0}catch(t){console.log("Api apiEndpoint Invalid Response:",t);return}}async function E(e,o,t=!1){if(t){let a=await W(e);if(a)return a}try{const a=await chrome.windows.create({url:e,focused:!1});chrome.windows.update(a.id,{width:0,height:0});const r=await chrome.tabs.query({windowId:a.id});if(await new Promise(i=>setTimeout(i,5e3)),await chrome.storage.local.get("TabIdsForBackgroundWindows",async i=>{i.TabIdsForBackgroundWindows?(i.TabIdsForBackgroundWindows[`${o}`]=a.id,await chrome.storage.local.set({TabIdsForBackgroundWindows:i.TabIdsForBackgroundWindows})):await chrome.storage.local.set({TabIdsForBackgroundWindows:{tabIdOfCurrentWindow:a.id}})}),r&&r.length>0){const i=await chrome.scripting.executeScript({target:{tabId:r[0].id},function:()=>document.body.innerHTML});if(i&&i[0])return chrome.windows.remove(a.id).catch(n=>console.log("Error While Closing Window",n)),i[0].result;await chrome.windows.remove(a.id).catch(n=>console.log("Error While Closing Window",n))}else await chrome.windows.remove(a.id).catch(i=>console.log("Error While Closing Window",i));await D(o)}catch(a){console.log("Error in fetching detail page Google Shopping data.",a)}}async function D(e,o=!1){try{await chrome.storage.local.get("TabIdsForBackgroundWindows",async t=>{t.TabIdsForBackgroundWindows&&t.TabIdsForBackgroundWindows[`${e}`]&&(o&&chrome.windows.remove(t.TabIdsForBackgroundWindows[`${e}`]).catch(a=>console.log("Error While Closing Window",a)),delete t.TabIdsForBackgroundWindows[`${e}`],await chrome.storage.local.set({TabIdsForBackgroundWindows:t.TabIdsForBackgroundWindows}))})}catch{console.log("On remove listener error")}}function x(e){const o="https://www.amazon.",t={US:"com",JP:"co.jp",UK:"co.uk"},a=r=>o+r+"/";return["CA","DE","ES","FR","IN","IT","NL"].some(r=>r===e)?a(e.toLowerCase()):a(t[e]||t.UK)}function U(e){if(!e)return;const o=[],t=e.markets;for(const a of t)o.push(x(a));return o}const j=e=>chrome.scripting.insertCSS({target:{tabId:e},files:["assets/main.css"]}),_=(e,o,t)=>chrome.tabs.sendMessage(e,{message:t,intervalId:o}).catch(a=>{a.message!=="Could not establish connection. Receiving end does not exist."&&console.log(a)}),I=(e,o)=>chrome.tabs.sendMessage(e,{message:o,loader:!1}).catch(t=>{t.message!=="Could not establish connection. Receiving end does not exist."&&console.log(t)});chrome.runtime.onInstalled.addListener(async()=>{if(navigator.onLine){await w();let e=await m();await chrome.storage.local.set({registered_stores_by_arbitrage:e})}});chrome.tabs.onUpdated.addListener(async(e,o,t)=>{var r,i;const a=/^(https?:\/\/)?(www\.)?amazon\.[a-z.]+/i;if(navigator.onLine){const n=l=>t.url.includes(l),{apiKey:s,apiKeyResponse:c}=await chrome.storage.local.get(["apiKey","apiKeyResponse"]),{store_container_is_appended:u}=await chrome.storage.local.get(["store_container_is_appended"]);if(o.status==="complete"&&u&&!k.some(n)&&(chrome.scripting.insertCSS({target:{tabId:e},files:["assets/main.css"]}),_(e,-1,"store_page_app")),!(s&&(c!=null&&c.license)&&(c!=null&&c.access.all||(r=c==null?void 0:c.access)!=null&&r.reverse_search))||!((i=U(c))!=null&&i.some(n)))return;if(a.test(t.url)&&[...f,...d].some(n)&&!k.some(n)){if(o.status!=="complete"){let l=null;j(e),f.some(n)&&!d.some(n)?l=setInterval(()=>_(e,l,"amazon_list_page_app"),400):d.some(n)&&(l=setInterval(()=>_(e,l,"product_detail_page_app"),400));return}o.status==="complete"&&(await chrome.storage.local.set({tab_url:t.url}),f.some(n)&&!d.some(n)?I(e,"amazon_list_page_loader"):d.some(n)&&I(e,"product_detail_page_loader"))}}});chrome.runtime.onMessage.addListener((e,o,t)=>{if(e.reverseSearch)return(async()=>t(await S(e.asin,e.market,e==null?void 0:e.mainServerAPICheck)))(),!0;if(e.productInfo)return(async()=>t(await T(e.asin,e.market,e==null?void 0:e.marketplace,e==null?void 0:e.mainServerAPICheck,e==null?void 0:e.bsr,e==null?void 0:e.category,e==null?void 0:e.salePrice)))(),!0;if(e.clear_interval)return clearInterval(e.intervalId),!0;if(e.getAllDataByArbitrage)return(async()=>{let a=await A();await chrome.storage.local.set({fulfilment_fee_distribution:a.profitCalculator,fulfilment_fee_distribution_xpaths:a.productDetailsPageXpath}),t(a)})(),!0;if(e.checkApiKeyValidation)return(async()=>t(await K(e.apiKey)))(),!0;if(e.currentUrl)return chrome.tabs.query({active:!0,currentWindow:!0},a=>t(a[0].url)),!0;if(e.getAllStoresDataByArbitrage)return(async()=>{let a=await m();await chrome.storage.local.set({registered_stores_by_arbitrage:a}),t(a)})(),!0;if(e.detailPageOffers)return(async()=>{const a=await E(e.urlEndpoint,o.tab.id,e.offersCheck);t(a)})(),!0});chrome.tabs.onRemoved.addListener(async(e,o)=>await D(e,!0));async function y(e,o){for(;;)await new Promise(t=>setTimeout(t,e)),await o()}y(24*60*60*1e3,async()=>{const o=(await new Promise(t=>chrome.storage.local.get("apiKey",t))).apiKey;o&&await K(o)});y(2*60*60*1e3,async()=>{let e=await m();e&&await chrome.storage.local.set({registered_stores_by_arbitrage:e})});y(2*60*60*1e3,async()=>{await w()});const C=()=>setInterval(chrome.runtime.getPlatformInfo,2e4);chrome.runtime.onStartup.addListener(C);C();
